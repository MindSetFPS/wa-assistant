<script lang="ts">
	import {
		DarkMode,
		Sidebar,
		SidebarDropdownWrapper,
		SidebarGroup,
		SidebarItem,
		SidebarWrapper,
		Modal,
		Button
	} from 'flowbite-svelte';
	import { ChartSolid, GridSolid, MailBoxSolid, UserSolid, ArrowLeftToBracketOutline, ArrowLeftToBracketSolid, ExclamationCircleOutline } from 'flowbite-svelte-icons';
	import { createEventDispatcher } from 'svelte';
	// import { sineIn } from 'svelte/easing';
	import supabase from '$lib/supabaseClient';
	import type { Tables } from '$lib/supabase';
	import { page } from '$app/stores';
	import type { SubmitFunction } from '@sveltejs/kit';

	// Removing "enhance" made the request work despite the supabase tutorial uses it
	// import { enhance } from '$app/forms';
	let loading = false


	$: activeUrl = $page.url.pathname;

	let spanClass = 'flex-1 ms-3 whitespace-nowrap';
	// let activateClickOutside = false;
	// let backdrop = false;
	// let transitionParams = {
	// 	x: -320,
	// 	duration: 200,
	// 	easing: sineIn
	// };

	export let conversations: any[] = [];
	$: otherconversations = conversations != undefined ? conversations : undefined
	console.log(otherconversations);
	// chats = json
	// conversations = [];

	// async function getConversations() {
	// 	let { data: messages, error } = await supabase.from('conversations').select('customer_id');
	// 	if (messages) {
	// 		chats = messages;
	// 	}

	// 	if (error) {
	// 		console.log(error);
	// 	}
	// }

	// getConversations();

	const handleSignOut: SubmitFunction = () => {
		loading = true
		return async ({ update }) => {
			loading = false
			update()
		}
	}
	const dispatch = createEventDispatcher();
	let popupModal = false;
</script>

<Modal bind:open={popupModal} size="xs" autoclose>
	<div class="text-center">
	  <ExclamationCircleOutline class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" />
	  <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Cerrar sesi√≥n?</h3>
	  
	  <form method="post" action="/account?/signout" use:enhance={handleSignOut}>
		<div>
			<button class="button block" disabled={loading}>Sign Out</button>
		</div>
	</form>


	  <Button color="alternative">No, cancel</Button>
	</div>
  </Modal>

<div class="h-full w-full list-none md:w-auto">
	<Sidebar class="h-full w-full" {activeUrl}>
		<SidebarWrapper class="h-full w-full">
			<SidebarDropdownWrapper label="Navegacion">
				<SidebarItem label="Dashboard">
					<svelte:fragment slot="icon">
						<ChartSolid
							class="ml-6 h-5 w-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
						/>
					</svelte:fragment>
				</SidebarItem>

				<SidebarItem label="Kanban" {spanClass}>
					<svelte:fragment slot="icon">
						<GridSolid
							class="ml-6 h-5 w-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
						/>
					</svelte:fragment>
					<svelte:fragment slot="subtext">
						<span
							class="ms-3 inline-flex items-center justify-center rounded-full bg-gray-200 px-2 text-sm font-medium text-gray-800 dark:bg-gray-700 dark:text-gray-300"
						>
							Pro
						</span>
					</svelte:fragment>
				</SidebarItem>

				<SidebarItem label="Inbox" {spanClass}>
					<svelte:fragment slot="icon">
						<MailBoxSolid
							class="ml-6 h-5 w-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
						/>
					</svelte:fragment>
					<svelte:fragment slot="subtext">
						<span
							class="text-primary-600 bg-primary-200 dark:bg-primary-900 dark:text-primary-200 ml-6 ms-3 inline-flex h-3 w-3 items-center justify-center rounded-full p-3 text-sm font-medium"
						>
							3
						</span>
					</svelte:fragment>
				</SidebarItem>

				<SidebarItem label="Log Out" {spanClass} on:click={() => (popupModal = true)} >
					<svelte:fragment slot="icon">
						<ArrowLeftToBracketOutline
							class="ml-6 h-5 w-5  text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
						/>

					</svelte:fragment>
					<svelte:fragment slot="subtext">
						<span
							class="text-primary-600 bg-primary-200 dark:bg-primary-900 dark:text-primary-200 ml-6 ms-3 inline-flex h-3 w-3 items-center justify-center rounded-full p-3 text-sm font-medium"
						>
							3
						</span>
					</svelte:fragment>
				</SidebarItem>

				<!-- <SidebarItem label="Modo oscuro" active={true}> -->
					<!-- <svelte:fragment slot="icon"> -->
						<!-- <UserSolid class="ml-6 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" /> -->
						<!-- <DarkMode btnClass="ml-6" /> -->
					<!-- </svelte:fragment> -->
				<!-- </SidebarItem> -->
			</SidebarDropdownWrapper>

			<SidebarGroup>
				<SidebarItem label="Chats" active={activeUrl === '/docs/components/sidebar'}>
					<svelte:fragment slot="icon">
						<UserSolid
							class=" h-5 w-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
						/>
					</svelte:fragment>
				</SidebarItem>
				{#await conversations}
					aaaa.......
				{:then}
					{#if conversations != undefined}
						{#each conversations as chat, index}
							<SidebarItem
								label={chat.customer_id}
								on:click={() => {
									dispatch('chatClicked', { chatIndex: index });
								}}
							>
								<svelte:fragment slot="icon">
									<UserSolid
										class="ml-6 h-5 w-5 text-gray-500 transition duration-75 group-hover:text-gray-900 dark:text-gray-400 dark:group-hover:text-white"
									/>
								</svelte:fragment>
							</SidebarItem>
						{/each}
					{/if}
				{/await}
			</SidebarGroup>
		</SidebarWrapper>
	</Sidebar>
</div>
